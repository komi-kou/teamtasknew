# Render デプロイメントガイド

このガイドでは、Renderでアプリケーションをデプロイし、複数のブラウザやデバイス間でデータを共有できるようにするための設定方法を説明します。

## 🔧 必須環境変数の設定

Renderのダッシュボードで、以下の環境変数を設定してください：

### バックエンド環境変数（必須）

1. **`DATABASE_URL`** ✅ 既に設定済み
   - PostgreSQLの接続文字列
   - 例: `postgresql://user:password@host:port/database`

2. **`JWT_SECRET`** ✅ 既に設定済み
   - JWTトークンの署名に使用する秘密鍵
   - 強力なランダム文字列を設定してください

3. **`NODE_ENV`** ✅ 既に設定済み
   - `production` に設定

4. **`ALLOWED_ORIGINS`** ⚠️ **重要：追加が必要**
   - CORSで許可するオリジンをカンマ区切りで指定
   - **値**: `https://teamtasknew.onrender.com`
   - 複数のオリジンを許可する場合: `https://teamtasknew.onrender.com,https://example.com`

5. **`REACT_APP_API_URL`** ✅ 既に設定済み
   - フロントエンドのビルド時に使用されるAPIのURL
   - **値**: `https://teamtasknew.onrender.com/api`

6. **`REACT_APP_SOCKET_URL`** ✅ 既に設定済み
   - フロントエンドのビルド時に使用されるSocket.ioのURL
   - **値**: `https://teamtasknew.onrender.com`

### オプション環境変数（推奨）

7. **`REDIS_URL`** ⚠️⚠️⚠️ **マルチインスタンス対応に必須（重要！）**
   - Redisの接続URL（マルチインスタンス環境でSocket.ioを同期するため）
   - **Renderは複数のインスタンスを起動する可能性があるため、この設定がないとデータ同期が正しく動作しません**
   - RenderでRedisアドオンを追加した場合、自動的に設定されます
   - **設定方法**:
     1. Renderダッシュボードでサービスを開く
     2. 左側のメニューから「Add-ons」を選択
     3. 「+ New Add-on」をクリック
     4. 「Redis」を選択
     5. プランを選択（無料プランでOK）
     6. 「Add Redis」をクリック
     7. Redisアドオンを追加すると、`REDIS_URL`環境変数が自動的に設定されます
   - 設定しない場合、シングルインスタンスモードで動作しますが、**複数のインスタンスが起動するとデータ同期が失敗します**

8. **`NEXTAUTH_SECRET`** ✅ 既に設定済み（オプション）
   - NextAuth.jsを使用する場合の秘密鍵

## 📝 環境変数の設定手順

1. Renderダッシュボードでサービスを開く
2. 左側のメニューから「Environment」を選択
3. 「Environment Variables」セクションで「+ Create environment group」または既存の変数を編集
4. 以下の環境変数を追加/確認：

```
ALLOWED_ORIGINS=https://teamtasknew.onrender.com
```

## 🚀 デプロイ後の確認事項

### 1. サーバーログの確認

デプロイ後、Renderのログで以下を確認してください：

```
✅ CORS設定: 環境変数から取得 [ 'https://teamtasknew.onrender.com' ]
🌐 許可されたオリジン: [ 'https://teamtasknew.onrender.com' ]
✅ Redisアダプターが有効になりました（マルチインスタンス対応）
```

または（Redis未設定の場合）：

```
ℹ️ Redis URLが設定されていません（シングルインスタンスモード）
```

### 2. ブラウザのコンソールで確認

1. アプリケーションを開く
2. ブラウザの開発者ツール（F12）を開く
3. コンソールタブで以下を確認：

```
✅ Socket.io接続成功, teamId: [チームID]
👥 チームに参加: [チームID]
```

エラーが表示される場合：

```
❌ Socket.io接続エラー: [エラーメッセージ]
```

### 3. データ同期のテスト

1. ブラウザAでタスクを追加
2. ブラウザB（別のブラウザまたはシークレットモード）で同じチームにログイン
3. ブラウザBでタスクが表示されることを確認

## 🔍 トラブルシューティング

### 問題1: Socket.io接続エラー

**症状**: ブラウザのコンソールに `❌ Socket.io接続エラー` が表示される

**原因と解決策**:
- **CORSエラー**: `ALLOWED_ORIGINS`環境変数が正しく設定されているか確認
- **URL不一致**: `REACT_APP_SOCKET_URL`が正しいURLを指しているか確認
- **サーバー未起動**: Renderのログでサーバーが正常に起動しているか確認

### 問題2: データが同期されない ⚠️ 最も一般的な問題

**症状**: 別のブラウザでデータが更新されない

**原因と解決策**:
1. **マルチインスタンス問題（最も可能性が高い）**:
   - Renderは複数のインスタンスを起動する可能性があります
   - Redisアダプターが設定されていない場合、各インスタンス間でSocket.ioのルーム管理が共有されません
   - **解決策**: Redisアドオンを追加して`REDIS_URL`環境変数を設定してください
   - **確認方法**: Renderのログで「⚠️⚠️⚠️ 警告: 本番環境でRedisアダプターが設定されていません！」というメッセージが表示されていないか確認

2. **Socket.io未接続**:
   - ブラウザのコンソールで接続状態を確認
   - サイドバーに「リアルタイム同期: 接続中」が緑色で表示されているか確認
   - エラーメッセージがないか確認

3. **チームID不一致**:
   - 同じチームコードでログインしているか確認
   - ブラウザのコンソールで`teamId`が一致しているか確認

4. **dataType不一致**:
   - ブラウザのコンソールで「📥 [Tasks] Real-time data update received」というログを確認
   - `dataType`が正しく一致しているか確認

### 問題3: CORSエラー

**症状**: ブラウザのコンソールに `CORS policy violation` が表示される

**解決策**:
1. `ALLOWED_ORIGINS`環境変数を設定
2. 値は `https://teamtasknew.onrender.com` （末尾のスラッシュなし）
3. 環境変数を設定後、サービスを再デプロイ

## 📊 マルチインスタンス対応について

Renderは複数のインスタンスを起動する可能性があります。この場合、Socket.ioのルーム管理が各インスタンス間で共有されないため、データ同期が正しく動作しません。

### 解決策: Redisアダプターの使用

1. Renderダッシュボードで「Add-ons」を選択
2. 「Redis」を追加
3. Redisアドオンを追加すると、`REDIS_URL`環境変数が自動的に設定されます
4. サービスを再デプロイ

これにより、複数のインスタンス間でSocket.ioの状態が共有され、データ同期が正しく動作します。

## ✅ チェックリスト

デプロイ前に以下を確認してください：

- [ ] `ALLOWED_ORIGINS`環境変数が設定されている
- [ ] `REACT_APP_API_URL`が正しいURLを指している
- [ ] `REACT_APP_SOCKET_URL`が正しいURLを指している
- [ ] `DATABASE_URL`が正しく設定されている
- [ ] `JWT_SECRET`が強力なランダム文字列に設定されている
- [ ] `NODE_ENV`が`production`に設定されている
- [ ] （推奨）`REDIS_URL`が設定されている（マルチインスタンス対応）

## 🎯 次のステップ

環境変数を設定した後：

1. サービスを再デプロイ
2. ブラウザのコンソールで接続状態を確認
3. 複数のブラウザでデータ同期をテスト

問題が解決しない場合は、Renderのログとブラウザのコンソールログを確認してください。

